<!DOCTYPE html>

<script src="leaflet.js"> // insertion bibliothèque Leaflet : http://leafletjs.com/ </script>

<title>Hydrométrie en Bretagne</title>
<link rel="stylesheet" type="text/css" href="leaflet.css" />
<link rel="stylesheet" type="text/css" href="style.css"/>

<meta charset="utf-8">


	<body id=body onload="load_data()">  <!-- Récupération des données avec le chargement de la page -->


		<h1>
			<img src="/images/Triskele.png">
				Hydrométrie des rivières bretonnes
				<img src="/images/Triskele.png">
				</h1>

				<h2>Carte de la Bretagne</h2>
				<div id="map"></div>

				<div id="Gestion">


		  	<h2 id="gestionTitle">Gestion des graphiques</h2>
				<button id="gestion" type="bouton" onclick="scrollGO();">GO</button>
			  </div>

				<form id="form" method="post">

					<fieldset>
						<legend>Quelle periode ?</legend>
						<div id='selecteur'>
							<div id = "Datedebut">

								<legend>Entrer la date de début</legend>
								<select id="Jourdebut">Jour
									<option value="01" selected="selected">Jour</option>
									<option value="01">01</option>
									<option value="02">02</option>
									<option value="03">03</option>
									<option value="04">04</option>
									<option value="05">05</option>
									<option value="06">06</option>
									<option value="07">07</option>
									<option value="08">08</option>
									<option value="09">09</option>
									<option value="10">10</option>
									<option value="11">11</option>
									<option value="12">12</option>
									<option value="13">13</option>
									<option value="14">14</option>
									<option value="15">15</option>
									<option value="16">16</option>
									<option value="17">17</option>
									<option value="18">18</option>
									<option value="19">19</option>
									<option value="20">20</option>
									<option value="21">21</option>
									<option value="22">22</option>
									<option value="23">23</option>
									<option value="24">24</option>
									<option value="25">25</option>
									<option value="26">26</option>
									<option value="27">27</option>
									<option value="28">28</option>
									<option value="29">29</option>
									<option value="30">30</option>
									<option value="31">31</option>

								</select>

								<select id="Moisdebut">Mois
									<option value="09" selected="selected">Mois</option>
									<option value="01">Janvier</option>
									<option value="02">Fevrier</option>
									<option value="03">Mars</option>
									<option value="04">Avril</option>
									<option value="05">Mai</option>
									<option value="06">Juin</option>
									<option value="07">Juillet</option>
									<option value="08">Aout</option>
									<option value="09">Septembre</option>
									<option value="10">Octobre</option>
									<option value="11">Novembre</option>
									<option value="12">Decembre</option>
								</select>

								<select id="Anneedebut">Année
									<option value="2017" selected="selected">Année</option>
									<option value="2017">2017</option>
									<option value="2018">2018</option>

								</select>

							</div>

							<div id='Datefin'>

								<legend>Entrer la date de fin</legend>
								<select id="Jourfin" id="Jourfin">Jour
									<option value="01" selected="selected">Jour</option>
									<option value="01">01</option>
									<option value="02">02</option>
									<option value="03">03</option>
									<option value="04">04</option>
									<option value="05">05</option>
									<option value="06">06</option>
									<option value="07">07</option>
									<option value="08">08</option>
									<option value="09">09</option>
									<option value="10">10</option>
									<option value="11">11</option>
									<option value="12">12</option>
									<option value="13">13</option>
									<option value="14">14</option>
									<option value="15">15</option>
									<option value="16">16</option>
									<option value="17">17</option>
									<option value="18">18</option>
									<option value="19">19</option>
									<option value="20">20</option>
									<option value="21">21</option>
									<option value="22">22</option>
									<option value="23">23</option>
									<option value="24">24</option>
									<option value="25">25</option>
									<option value="26">26</option>
									<option value="27">27</option>
									<option value="28">28</option>
									<option value="29">29</option>
									<option value="30">30</option>
									<option value="31">31</option>

								</select>

								<select id="Moisfin">Mois
									<option value="09" selected="selected">Mois</option>
									<option value="01">Janvier</option>
									<option value="02">Fevrier</option>
									<option value="03">Mars</option>
									<option value="04">Avril</option>
									<option value="05">Mai</option>
									<option value="06">Juin</option>
									<option value="07">Juillet</option>
									<option value="08">Août</option>
									<option value="09">Septembre</option>
									<option value="10">Octobre</option>
									<option value="11">Novembre</option>
									<option value="12">Décembre</option>
								</select>

								<select id="Anneefin">Année
									<option value="2018" selected="selected">Année</option>
									<option value="2017">2017</option>
									<option value="2018">2018</option>
								</select>

							</div>

						</div>
					</fieldset>

					<fieldset>
						<legend>Que voulez vous afficher ?</legend>

						<input type ="checkbox" name = "Debit" id = "Debit" checked/><label for="Debit">Debit</label>
						<input type ="checkbox" name = "Moyenne Interanuelle" id = "Moyenne_Interanuelle" value= /><label for="Moyenne Interanuelle">Moyenne Interanuelle</label>
						<input type ="checkbox" name = "Valeur faible" id = "Valeur_faible" /><label for="Valeur faible">Valeur faible</label>
						<input type ="checkbox" name = "Valeur forte" id = "Valeur_forte" /><label for="Valeur forte">Valeur forte</label>

					</fieldset>

				</form>

				<fieldset id="Valider">
					<button id="valider" type="bouton" onclick="Valider();"> Valider </button>
				</fieldset>

				<div id="reponse">
					<p></p>
					<img width="80%" src="" />
				</div>

			</body>

			<footer>
				© Copyright Groupe D 2019 - Tous droits réservés
			</footer>

			<div><a id="cRetour" class="cInvisible" onclick="window.scroll({ top: 0, behavior: 'smooth' })"></a></div>

		<script>
				document.addEventListener('DOMContentLoaded', function() {
				window.onscroll = function(ev) {
				document.getElementById("cRetour").className = (window.pageYOffset > 100) ? "cVisible" : "cInvisible";
			};
			});

			// variable globale
			graphiqueSource= "images/cadre.png";

			// Creation d'une carte dans la balise div "map", et positionne la vue sur un point donné et un niveau de zoom
			var map = L.map('map').setView([48.15,-3], 7.5);
			// Ajout d'une couche de dalles OpenStreetMap
			L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
			attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
			}).addTo(map);

			// Creation d'un type de marqueur de couleur grise
			var greyMarker = L.icon({
			iconUrl: 'images/marker-icon-2x-gris.png',
			shadowUrl: 'images/marker-shadow.png',
			iconSize:[25,41],
			shadowSize:[41,41],
			iconAnchor:[12,41],
			popupAnchor:[1,-34]
			});

			// fonction appelée lors du (re)chargement de la page
			function load_data () {

				var xhr = new XMLHttpRequest();
				xhr.onload = function() {   // fonction callback
					// récupération des données renvoyées par le serveur
					var data = JSON.parse(this.responseText);
					// boucle sur les enregistrements renvoyés
					for ( n = 0; n < data.length; n++ ) {
						// insertion d'un marqueur à la position, attachement d'une popup, capture de l'évènement "clic'
						// le marqueur est gris si les données de la station ne sont pas disponibles
						if(data[n].datAv==0){
							var marke = L.marker([data[n].lat,data[n].lon],{icon:greyMarker});
						}else{
							var marke = L.marker([data[n].lat,data[n].lon]);
						}
						marke.addTo(map)
						.bindPopup(data[n].nom);
						marke.idreg=data[n].cd;   // propriétés personnalisées ajoutées au marqueur
						marke.dataIsAv=data[n].datAv;
						marke.nom=data[n].nom;
						marke.addEventListener('click',OnMarkerClick);	// fonction appelée lors du clic sur un marqueur
					}
				};
				xhr.open('GET','/stations',true);		// requête au serveur pour récupérer les noms et localisations des stations
				xhr.send();
				document.querySelector('#reponse img').src=graphiqueSource;	// initialisation de l'image réponse à un cadre vide
			}

			// variables globales qui vont être définies dans certaines fonctions et utilisées dans d'autres
			// (c'est le cas pour toutes les variables déclarées sans 'var'
			stationID="";
			dataIsAv="";

			// fonction appelée lors du clic sur un marqueur
			// elle permet de transmettre les informations associées à ce marqueur au reste du script
			function OnMarkerClick (e) {
				stationID=e.target.idreg;
				dataIsAv=e.target.dataIsAv;
				nomStat=e.target.nom;

				document.querySelector('#reponse p').innerHTML=nomStat;
				document.querySelector('#reponse img').src = graphiqueSource;
			}

			// fonction appelée lors du clic sur le bouton GO
			function scrollGO(e)
			{
				document.querySelector('#form')
				.scrollIntoView({ behavior: 'smooth' });	// scroll jusqu'à ce que le formulaire soit en haut de la fenêtre
				graphRequest();														// effectue la reqête vers le serveur permettant de récupérer le bon graphique
			}

			// fonction appelée lors du clic sur le bouton 'valider' ou sur la touche 'entrée'
			function Valider(e){
				// variables globales issues du formulaire qui pourront être utilisées dans la fonction graphRequest
				anD=document.querySelector('#Anneedebut').value;
				moisD=document.querySelector('#Moisdebut').value;
				jourD=document.querySelector('#Jourdebut').value;
				anF=document.querySelector('#Anneefin').value;
				moisF=document.querySelector('#Moisfin').value;
				jourF=document.querySelector('#Jourfin').value;
				typeGraphe="/graphe";
				checkDeb = document.querySelector('#Debit').checked;
				checkMoy= document.querySelector('#Moyenne_Interanuelle').checked;
				checkFaible = document.querySelector('#Valeur_faible').checked;
				checkForte = document.querySelector('#Valeur_forte').checked;

				// code à envoyer pour indiquer au serveur quels types de données envoyer
				if(checkDeb){
					typeGraphe+="/1";
				}else{
					typeGraphe+="/0";
				}
				if(checkMoy){
					typeGraphe+="/1";
				}else{
					typeGraphe+="/0";
				}
				if(checkFaible){
					typeGraphe+="/1";
				}else{
					typeGraphe+="/0";
				}
				if(checkForte){
					typeGraphe+="/1";
				}else {
					typeGraphe+="/0";
				}

				image =  document.querySelector('#reponse img'),
				legende = document.querySelector('#reponse p');

				graphRequest();	// effectue la reqête vers le serveur permettant de récupérer le bon graphique

			}

			function graphRequest(){
				var xhr = new XMLHttpRequest();

				xhr.onload = function() {   // fonction callback
					if(dataIsAv){							// si on a cliqué sur un marqueur bleu
						var data = JSON.parse(this.responseText)
						image.src = data.img;
						image.alt = data.title;
					}else{										// ou sur un marqueur gris
						image.src = graphiqueSource;
						legende.innerHTML = "Données manquantes";
					}

				};

				// code compris par le serveur pour générer un graphique particulier
				chaine=typeGraphe+'/'+anD+'/'+moisD+'/'+jourD+'/'+anF+'/'+moisF+'/'+jourF+'/'+stationID;

				xhr.open('GET',chaine,true);  // on récupère la courbe par un appel au serveur
				xhr.send();

			}


			// Activation du bouton 'valider' par un appui sur la touche 'entrée'
			var input = document.getElementById("body");
			input.addEventListener("keyup", function(event) {
			event.preventDefault();
			if (event.keyCode === 13) {
				document.getElementById("valider").click();
			}
			});


		</script>

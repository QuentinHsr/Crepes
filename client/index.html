<!DOCTYPE html>

<script src="leaflet.js"> // insertion bibliothèque Leaflet : http://leafletjs.com/ </script>

<title>Hydrométrie en Bretagne</title>
<link rel="stylesheet" type="text/css" href="leaflet.css" />
<link rel="stylesheet" type="text/css" href="style.css"/>

<meta charset="utf-8">

<style type="text/css">
h1,legend, label{font-size:40;}
body {,
height: 350px;
}
#reponse {font-size:22,color:cyan;}
</style>



<body onload="load_data()">  <!-- Récupération des données avec le chargement de la page -->

<h1>Hydrométrie des rivières bretonnes</h1>

 <!-- <label><span>Région :</span><input id="region" name="Region">
 <button id="bouton">Afficher la courbe</button>  </label>  -->
 <div id="map"></div>

<div id="reponse">
  <p></p>
  <img width="60%" src="" />
</div>
<div>
</div>


<style>
#map { height: 400px; width: 340px;
  float:left; margin-left:2%;
  margin-right:2%; border-top: 4px solid rgb(33,33,33);
  border-bottom: 4px solid rgb(33,33,33) ;
  border-left: 4px solid rgb(33,33,33);
  border-right: 4px solid rgb(33,33,33  )}
</style>

<div id = "X3">

<legend>Entrer la date qui vous interesse</legend>
<select name="Jour">Jour
    <option value="None",selected="selected">Jour</option>
    <option value="01">01</option>
    <option value="02">02</option>
    <option value="03">03</option>
    <option value="04">04</option>
    <option value="05">05</option>
    <option value="06">06</option>
    <option value="07">07</option>
    <option value="08">08</option>
    <option value="09">09</option>
    <option value="10">10</option>
    <option value="11">11</option>

</select>

<select name="Mois">Mois
    <option value="None",selected="selected">Mois</option>
    <option value="01">01</option>
    <option value="02">02</option>
    <option value="03">03</option>
    <option value="04">04</option>
    <option value="05">05</option>
    <option value="06">06</option>
    <option value="07">07</option>
    <option value="08">08</option>
    <option value="09">09</option>
    <option value="10">10</option>
    <option value="11">11</option>
</select>

<select name="Année">Année
    <option value="None",selected="selected">Année</option>

    <option value="1999">1999</option>
    <option value="1997">1997</option>
    <option value="2004">2004</option>
</select>

<button id="bouton" type="bouton"> C'est parti </button>
</div>
</body>


<script>
// Creation d'une carte dans la balise div "map", et positionne la vue sur un point donné et un niveau de zoom
var map = L.map('map').setView([48.15,-3], 7.5);
// Ajout d'une couche de dalles OpenStreetMap
L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
     attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
     }).addTo(map);

var greyMarker = L.icon({
   iconUrl: 'images/marker-icon-2x-gris.png',
   iconSize:[25,41],
   iconAnchor:[12,41],
   popupAnchor:[1,-34]
 });
function load_data () {
    var xhr = new XMLHttpRequest();
    xhr.onload = function() {   // fonction callback
      // récupération des données renvoyées par le serveur
	  var data = JSON.parse(this.responseText);
      // boucle sur les enregistrements renvoyés
      for ( n = 0; n < data.length; n++ ) {
        // insertion d'un marqueur à la position, attachement d'une popup, capture de l'évènement "clic'
        if(data[n].cd.length<=1){
          var marke = L.marker([data[n].lat,data[n].lon],{icon:greyMarker});
        }else{
          var marke = L.marker([data[n].lat,data[n].lon]);
        }
        marke.addTo(map)
        .bindPopup(data[n].nom);
        marke.idreg=data[n].cd;   // propriété personnalisée ajouté au marqueur
      //  marke.isAv=data[n].isAvailable;
        marke.addEventListener('click',OnMarkerClick);

	    }
    };
    xhr.open('GET','/stations',true);
    xhr.send();
}

function AfficheAv(e) {
    document.getElementById('reponse').innerHTML=e.target.isAv;
}

function OnMarkerClick (e) {
    var xhr = new XMLHttpRequest();
	var image =  document.querySelector('#reponse img'),
        legende = document.querySelector('#reponse p');
	xhr.onload = function() {   // fonction callback
      var data = JSON.parse(this.responseText)
      image.src = data.img;
      image.alt = data.title;
      legende.innerHTML = data.title;
      };
    xhr.open('GET','/debits/'+e.target.idreg,true);  // on récupère la courbe par un appel au serveur
    xhr.send();
}
</script>

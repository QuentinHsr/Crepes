<!DOCTYPE html>

<script src="leaflet.js"> // insertion bibliothèque Leaflet : http://leafletjs.com/ </script>

<title>Hydrométrie en Bretagne</title>
<link rel="stylesheet" type="text/css" href="leaflet.css" />
<link rel="stylesheet" type="text/css" href="style.css"/>

<meta charset="utf-8">


	<body id=body onload="load_data()">  <!-- Récupération des données avec le chargement de la page -->


		<h1>
			<img src="/images/Triskele.png">
				Hydrométrie des rivières bretonnes
				<img src="/images/Triskele.png">
				</h1>

				<h2>Carte de la Bretagne</h2>
				<div id="map"></div>

				<div>
				</div>

				<h2 id="Gestion">Gestion des graphiques</h2>
				<form method="post">

					<fieldset>
						<legend>Quelle periode ?</legend>
						<div id='selecteur'>
							<div id = "Datedebut">

								<legend>Entrer la date de début</legend>
								<select id="Jourdebut">Jour
									<option value="01" selected="selected">Jour</option>
									<option value="01">01</option>
									<option value="02">02</option>
									<option value="03">03</option>
									<option value="04">04</option>
									<option value="05">05</option>
									<option value="06">06</option>
									<option value="07">07</option>
									<option value="08">08</option>
									<option value="09">09</option>
									<option value="10">10</option>
									<option value="11">11</option>
									<option value="12">12</option>
									<option value="13">13</option>
									<option value="14">14</option>
									<option value="15">15</option>
									<option value="16">16</option>
									<option value="17">17</option>
									<option value="18">18</option>
									<option value="19">19</option>
									<option value="20">20</option>
									<option value="21">21</option>
									<option value="22">22</option>
									<option value="23">23</option>
									<option value="24">24</option>
									<option value="25">25</option>
									<option value="26">26</option>
									<option value="27">27</option>
									<option value="28">28</option>
									<option value="29">29</option>
									<option value="30">30</option>
									<option value="31">31</option>

								</select>

								<select id="Moisdebut">Mois
									<option value="09" selected="selected">Mois</option>
									<option value="01">Janvier</option>
									<option value="02">Fevrier</option>
									<option value="03">Mars</option>
									<option value="04">Avril</option>
									<option value="05">Mai</option>
									<option value="06">Juin</option>
									<option value="07">Juillet</option>
									<option value="08">Aout</option>
									<option value="09">Septembre</option>
									<option value="10">Octobre</option>
									<option value="11">Novembre</option>
									<option value="12">Decembre</option>
								</select>

								<select id="Anneedebut">Année
									<option value="2017" selected="selected">Année</option>
									<option value="2017">2017</option>
									<option value="2018">2018</option>

								</select>

							</div>

							<div id='Datefin'>

								<legend>Entrer la date de fin</legend>
								<select id="Jourfin" id="Jourfin">Jour
									<option value="01" selected="selected">Jour</option>
									<option value="01">01</option>
									<option value="02">02</option>
									<option value="03">03</option>
									<option value="04">04</option>
									<option value="05">05</option>
									<option value="06">06</option>
									<option value="07">07</option>
									<option value="08">08</option>
									<option value="09">09</option>
									<option value="10">10</option>
									<option value="11">11</option>
									<option value="12">12</option>
									<option value="13">13</option>
									<option value="14">14</option>
									<option value="15">15</option>
									<option value="16">16</option>
									<option value="17">17</option>
									<option value="18">18</option>
									<option value="19">19</option>
									<option value="20">20</option>
									<option value="21">21</option>
									<option value="22">22</option>
									<option value="23">23</option>
									<option value="24">24</option>
									<option value="25">25</option>
									<option value="26">26</option>
									<option value="27">27</option>
									<option value="28">28</option>
									<option value="29">29</option>
									<option value="30">30</option>
									<option value="31">31</option>

								</select>

								<select id="Moisfin">Mois
									<option value="09" selected="selected">Mois</option>
									<option value="01">Janvier</option>
									<option value="02">Fevrier</option>
									<option value="03">Mars</option>
									<option value="04">Avril</option>
									<option value="05">Mai</option>
									<option value="06">Juin</option>
									<option value="07">Juillet</option>
									<option value="08">Août</option>
									<option value="09">Septembre</option>
									<option value="10">Octobre</option>
									<option value="11">Novembre</option>
									<option value="12">Décembre</option>
								</select>

								<select id="Anneefin">Année
									<option value="2018" selected="selected">Année</option>
									<option value="2017">2017</option>
									<option value="2018">2018</option>
								</select>

							</div>

						</div>
					</fieldset>

					<fieldset>
						<legend>Que voulez vous afficher ?</legend>

						<input type ="checkbox" name = "Debit" id = "Debit" checked/><label for="Debit">Debit</label>
						<input type ="checkbox" name = "Moyenne Interanuelle" id = "Moyenne_Interanuelle" value= /><label for="Moyenne Interanuelle">Moyenne Interanuelle</label>
						<input type ="checkbox" name = "Valeur faible" id = "Valeur_faible" /><label for="Valeur faible">Valeur faible</label>

					</fieldset>

				</form>

				<fieldset id="Valider">
					<button id="valider" type="bouton" onclick="Valider();"> Valider </button>
				</fieldset>

				<div id="reponse">
					<p></p>
					<img width="80%" src="" />
				</div>

			</body>

			<footer>
				© Copyright Groupe D 2019 - Tous droits réservés
			</footer>

			<div><a id="cRetour" class="cInvisible" onclick="window.scroll({ top: 0, behavior: 'smooth' })"></a></div>


			<script>
				document.addEventListener('DOMContentLoaded', function() {
				window.onscroll = function(ev) {
				document.getElementById("cRetour").className = (window.pageYOffset > 100) ? "cVisible" : "cInvisible";
			};
			});

			//variables globales
			graphiqueSource= "images/cadre.png";

			// Creation d'une carte dans la balise div "map", et positionne la vue sur un point donné et un niveau de zoom
			var map = L.map('map').setView([48.15,-3], 7.5);
			// Ajout d'une couche de dalles OpenStreetMap
			L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
			attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
			}).addTo(map);

			var greyMarker = L.icon({
			iconUrl: 'images/marker-icon-2x-gris.png',
			shadowUrl: 'images/marker-shadow.png',
			iconSize:[25,41],
			shadowSize:[41,41],
			iconAnchor:[12,41],
			popupAnchor:[1,-34]
			});

			function load_data () {
			var xhr = new XMLHttpRequest();
			xhr.onload = function() {   // fonction callback
			// récupération des données renvoyées par le serveur
			var data = JSON.parse(this.responseText);
			// boucle sur les enregistrements renvoyés
			for ( n = 0; n < data.length; n++ ) {
					// insertion d'un marqueur à la position, attachement d'une popup, capture de l'évènement "clic'
					if(data[n].datAv==0){
					var marke = L.marker([data[n].lat,data[n].lon],{icon:greyMarker});
					}else{
					var marke = L.marker([data[n].lat,data[n].lon]);
					}
					marke.addTo(map)
					.bindPopup(data[n].nom);
					marke.idreg=data[n].cd;   // propriété personnalisée ajouté au marqueur
					marke.dataIsAv=data[n].datAv;
					marke.nom=data[n].nom;
					marke.addEventListener('click',OnMarkerClick);

					}
					};
					xhr.open('GET','/stations',true);
					xhr.send();
					document.querySelector('#reponse img').src=graphiqueSource;

					}

					function AfficheAv(e) {
					document.querySelector('#reponse p').innerHTML=stationID;
					}



					stationID="";
					dataIsAv="";

					function OnMarkerClick (e) {
					stationID=e.target.idreg;
					dataIsAv=e.target.dataIsAv;
					nomStat=e.target.nom;
					document.querySelector('#reponse p').innerHTML=nomStat;
					document.querySelector('#reponse img').src = graphiqueSource;
					document.querySelector('#Gestion')
					.scrollIntoView({ behavior: 'smooth' });

					}

					function Valider(e){
					//  jourf = document.getElementById('Jourfin').value;
					//  document.querySelector('#reponse p').innerHTML=jourf;
					//window.scrollBy(0,-1000);

					var xhr = new XMLHttpRequest();
					var image =  document.querySelector('#reponse img'),
					legende = document.querySelector('#reponse p');
					xhr.onload = function() {   // fonction callback
					if(dataIsAv){
					var data = JSON.parse(this.responseText)
					image.src = data.img;
					image.alt = data.title;
					//	legende.innerHTML = nomStat;
					//		legende.innerHTML=stationID;
					}else{
					image.src = graphiqueSource;
					legende.innerHTML = "Données manquantes";
					}

					};
					var anD='/'+document.querySelector('#Anneedebut').value;
					var moisD='/'+document.querySelector('#Moisdebut').value;
					var jourD='/'+document.querySelector('#Jourdebut').value;
					var anF='/'+document.querySelector('#Anneefin').value;
					var moisF='/'+document.querySelector('#Moisfin').value;
					var jourF='/'+document.querySelector('#Jourfin').value;
					var typeGraphe="/ /";
					var checkDeb = document.querySelector('#Debit').checked;
					var checkMoy= document.querySelector('#Moyenne_Interanuelle').checked;
					var checkFaible = document.querySelector('#Valeur_faible').checked;

					if(checkDeb && checkMoy){
					typeGraphe="/debits_moyennes/";
					}else if(checkDeb){
					typeGraphe="/debits/";
					}else if(checkMoy){
					typeGraphe="/moyennes/";
					}

					chaine=typeGraphe+stationID+anD+moisD+jourD+anF+moisF+jourF;

					xhr.open('GET',chaine,true);  // on récupère la courbe par un appel au serveur
					xhr.send();

					}


					// Get the input field
					var input = document.getElementById("body");

					// Execute a function when the user releases a key on the keyboard
					input.addEventListener("keyup", function(event) {
					// Cancel the default action, if needed
					event.preventDefault();
					// Number 13 is the "Enter" key on the keyboard
					if (event.keyCode === 13) {
					// Trigger the button element with a click
					document.getElementById("valider").click();
					}
					});


				</script>
				